(function(){var n,y,z,A,B,p,C,a,i;i="undefined"!==typeof exports&&null!==exports?exports:this;a=null;A=function(){function f(g,b,c){var d=this;this.width=b;this.height=c;a=g;this.ready=!1;this.radiansPerSecond=3.0E-4;this.transitionMilliseconds=750;this.style=n;this.sketchy=!0;this.programs={};this.hotMouse=!1;this.initializeGL();this.gallery=new i.Gallery;this.highlightRow=this.gallery.j;this.worker=new Worker("js/worker.min.js");this.worker.onmessage=function(a){return d.onWorkerMessage(a.data)};
this.worker.postMessage({command:"download-spines",url:document.URL+"data/centerlines.bin"})}f.name="Display";f.prototype.renderIconLink=function(a,b,c){var d,e,h,k;k=[];e=0;for(h=a.length;e<h;e++)d=a[e],k.push(this.renderIconKnot(d,a,b,c));return k};f.prototype.renderBigLink=function(a,b){var c,d,e,h;h=[];d=0;for(e=a.length;d<e;d++)c=a[d],h.push(this.renderBigKnot(c,a,b));return h};f.prototype.render=function(){var g,b,c,d,e,h,k,j,f,l;this.gallery.row().loaded||this.tessRow();g=(new Date).getTime();
if(null!=this.previousTime){c=g-this.previousTime;b=this.radiansPerSecond*c;0===i.pageIndex&&(b*=32);h=null!=(e=this.highlightRow)?e:null;1===i.pageIndex&&(h=this.gallery.j);j=this.gallery.links;c=k=0;for(d=j.length;k<d;c=++k)e=j[c],e.theta=c===h||Math.abs(e.theta%B)>b?e.theta+b:0}this.previousTime=g;this.projection=mat4.perspective(45,this.width/this.height,5,90);g=mat4.lookAt([0,-5,5],[0,0,0],[0,1,0]);this.updateViewports();k=this.gallery.links;c=b=0;for(h=k.length;b<h;c=++b){e=k[c];d=mat4.create();
this.modelview=mat4.create();mat4.identity(d);mat4.rotateX(d,0.785);mat4.rotateY(d,e.theta);mat4.multiply(g,d,this.modelview);this.normalMatrix=mat4.toMat3(this.modelview);j=0;for(f=e.length;j<f;j++)if(d=e[j],0===d.iconified&&(d.alpha=0.3),1===d.iconified)d.alpha=1;j=0;for(f=e.length;j<f;j++)d=e[j],null==d.hidden&&this.renderIconLink(d,d.tableBox,1);if(c===this.gallery.j){j=0;for(c=e.length;j<c;j++)d=e[j],d.ready&&this.renderIconLink(d,d.iconBox,d.alpha);for(c=f=0;1>=f;c=++f){l=0;for(j=e.length;l<
j;l++)d=e[l],this.renderBigLink(d,c)}}}if(a.getError()!==a.NO_ERROR)return glerr("Render")};f.prototype.initializeGL=function(){this.compileShaders();a.enable(a.CULL_FACE);if(a.getError()!==a.NO_ERROR)return glerr("OpenGL error during init")};f.prototype.onWorkerMessage=function(g){var b,c,d,e,h,k;switch(g.command){case "debug-message":return toast(g.text);case "spine-data":return this.spines=this.createVbo(a.ARRAY_BUFFER,g.data),this.spines.scale=g.scale,this.ready=!0;case "mesh-link":b=g.id;d=b[1];
b=b[2];b=this.gallery.link(d,b);k=g.meshes;c=e=0;for(h=k.length;e<h;c=++e)g=k[c],c=b[c].vbos={},c.tube=this.createVbo(a.ARRAY_BUFFER,g.tube),c.wireframe=this.createVbo(a.ELEMENT_ARRAY_BUFFER,g.wireframe),c.triangles=this.createVbo(a.ELEMENT_ARRAY_BUFFER,g.triangles);d=this.gallery.links[d];++d.loadCount===d.length&&(d.loaded=!0,d.loading=!1);return b.ready=!0}};f.prototype.createVbo=function(g,b){var c;c=a.createBuffer();a.bindBuffer(g,c);a.bufferData(g,b,a.STATIC_DRAW);c.count=b.length;return c};
f.prototype.tessRow=function(){var a,b,c,d,e,h;c=this.gallery.row();if(!c.loaded&&!c.loading&&this.ready&&0!==i.pageIndex){c.loading=!0;c.loadCount=0;h=[];d=0;for(e=c.length;d<e;d++){b=c[d];for(var k=b.id,f=void 0,q=void 0,l=void 0,l=[],f=0,q=b.length;f<q;f++)a=b[f],l.push(a.range);a={command:"tessellate-link",id:k,link:l};h.push(this.worker.postMessage(a))}return h}};f.prototype.getCurrentLinkInfo=function(){var a;a=this.gallery.link().id[0].split(".");return 2===a.length?{crossings:a[0],numComponents:"",
index:a[1]}:{crossings:a[0],numComponents:a[1],index:a[2]}};f.prototype.moveSelection=function(a,b){var c,d;c=this.gallery.i+a;d=this.gallery.j+b;if(!(d>=this.gallery.links.length||0>d))if(!(c>=this.gallery.links[d].length||0>c))return this.changeSelection(c,d)};f.prototype.changeSelection=function(a,b){var c,d,e,h,f;e=this.gallery.i;d=!1;if(b!==this.gallery.j){f=this.gallery.links[b];c=0;for(h=f.length;c<h;c++)d=f[c],d.iconified=1;this.gallery.links[b][a].ready||(a=0);this.gallery.links[b][a].iconified=
0;this.highlightRow=b;d=!0}this.gallery.i=a;this.gallery.j=b;i.AnimateNumerals();c=this.gallery.row();if(!d)if(d=c[this.gallery.i],e=c[e],0===e.iconified)c=this.transitionMilliseconds,this.incoming1=(new TWEEN.Tween(d)).to({alpha:0.3},c).start(),this.incoming2=(new TWEEN.Tween(d)).to({iconified:0},c).easing(TWEEN.Easing.Bounce.Out).start(),c=0.5*this.transitionMilliseconds,(new TWEEN.Tween(e)).to({alpha:1},c).start(),(new TWEEN.Tween(e)).to({iconified:1},c).easing(TWEEN.Easing.Quartic.Out).start();
else if(c=e.iconified,e.iconified=1,d.iconified=c,c=e.alpha,e.alpha=1,d.alpha=c,null!=this.incoming1&&this.incoming1.replace(d),null!=this.incoming2)return this.incoming2.replace(d)};f.prototype.updateViewports=function(){var a,b,c,d,e,h,f,j,q,l,t,m,r,s,o,u,v,n,w,x;a=new p(0,0,this.width,this.height);j=vec2.create([i.mouse.position.x,this.height-i.mouse.position.y]);this.hotMouse=!1;x=[];t=v=0;for(w=this.gallery.links.length;0<=w?v<w:v>w;t=0<=w?++v:--v){l=this.gallery.links[t];d=m=this.height/this.gallery.links.length;
s=m*this.width/this.height;r=this.width/(l.length+0.5);o=-this.width+r/2;u=this.height-m/2-m*t;m=0;for(n=l.length;m<n;m++)h=l[m],h.tableBox=p.createFromCenter([o,u],[s,d]),h.tableBox.inflate(s/5,d/5),o+=r;t===this.gallery.j&&(s=r=this.width/l.length,d=m=r*this.height/this.width,o=r/2,u=this.height-m/2,x.push(function(){var i,m,n;n=[];i=0;for(m=l.length;i<m;i++)h=l[i],e=p.createFromCenter([o,u],[s,d]),c=vec2.dist([o,u],j),q=d/2,c<q&&1===h.iconified&&(b=1-c/q,f=q/3,e.inflate(b*b*f),this.hotMouse=!0),
h.iconBox=e,h.centralBox=p.lerp(a,e,h.iconified),n.push(o+=s);return n}.call(this)))}return x};f.prototype.click=function(){var a,b,c,d,e,h,f;if(null!=this.gallery.links){d=this.gallery.row();c=vec2.create([i.mouse.position.x,this.height-i.mouse.position.y]);f=[];b=e=0;for(h=d.length;e<h;b=++e)(a=d[b])&&a.iconBox&&(a.iconBox.contains(c[0],c[1])&&1===a.iconified?f.push(this.changeSelection(b,this.gallery.j)):f.push(void 0));return f}};f.prototype.setColor=function(g,b,c){return a.uniform4f(g,b[0],
b[1],b[2],c)};f.prototype.setViewport=function(g){var b,c,g=g.translated(i.pan.x,0);b=new p(0,0,this.width,this.height);b=p.intersect(g,b);if(b.degenerate())return null;g=p.cropMatrix(b,g);c=mat4.create(this.projection);mat4.multiply(c,g);b.viewport(a);return c};f.prototype.renderIconKnot=function(g,b,c,d){var e,h,f,j,i;if(c=this.setViewport(c)){b=this.programs.wireframe;a.useProgram(b);a.uniform3f(b.worldOffset,g.offset[0],g.offset[1],g.offset[2]);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);
a.bindBuffer(a.ARRAY_BUFFER,this.spines);a.enableVertexAttribArray(semantics.POSITION);a.vertexAttribPointer(semantics.POSITION,3,a.FLOAT,!1,12,0);a.uniformMatrix4fv(b.modelview,!1,this.modelview);a.uniformMatrix4fv(b.projection,!1,c);a.uniform1f(b.scale,this.spines.scale);this.setColor(b.color,COLORS.black,d);e=g.range;c=e[0];e=e[1];a.enable(a.DEPTH_TEST);a.lineWidth(2);for(h=j=-1;1>=j;h=j+=2)for(f=i=-1;1>=i;f=i+=2)a.uniform2f(b.screenOffset,h,f),a.uniform1f(b.depthOffset,0),a.drawArrays(a.LINE_LOOP,
c,e);this.setColor(b.color,g.color,d);a.uniform2f(b.screenOffset,0,0);a.uniform1f(b.depthOffset,-0.5);a.drawArrays(a.LINE_LOOP,c,e);return a.disableVertexAttribArray(semantics.POSITION)}};f.prototype.renderBigKnot=function(g,b,c){var d,e;if(1!==b.iconified&&null!=g.vbos&&(d=this.setViewport(b.centralBox)))if(e=g.vbos,0===c&&(b=this.programs.solidmesh,a.enable(a.DEPTH_TEST),a.useProgram(b),this.setColor(b.color,g.color,1),a.uniform3f(b.worldOffset,g.offset[0],g.offset[1],g.offset[2]),a.uniformMatrix4fv(b.modelview,
!1,this.modelview),a.uniformMatrix3fv(b.normalmatrix,!1,this.normalMatrix),a.uniformMatrix4fv(b.projection,!1,d),a.bindBuffer(a.ARRAY_BUFFER,e.tube),a.enableVertexAttribArray(semantics.POSITION),a.enableVertexAttribArray(semantics.NORMAL),a.vertexAttribPointer(semantics.POSITION,3,a.FLOAT,!1,24,0),a.vertexAttribPointer(semantics.NORMAL,3,a.FLOAT,!1,24,12),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.triangles),this.style===n&&(a.enable(a.POLYGON_OFFSET_FILL),a.polygonOffset(-1,12)),a.drawElements(a.TRIANGLES,
e.triangles.count,a.UNSIGNED_SHORT,0),a.disableVertexAttribArray(semantics.POSITION),a.disableVertexAttribArray(semantics.NORMAL),a.disable(a.POLYGON_OFFSET_FILL)),1===c)return a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),b=this.programs.wireframe,a.useProgram(b),a.uniform3f(b.worldOffset,g.offset[0],g.offset[1],g.offset[2]),a.uniformMatrix4fv(b.modelview,!1,this.modelview),a.uniformMatrix4fv(b.projection,!1,d),a.uniform1f(b.scale,1),a.bindBuffer(a.ARRAY_BUFFER,e.tube),a.enableVertexAttribArray(semantics.POSITION),
a.vertexAttribPointer(semantics.POSITION,3,a.FLOAT,!1,24,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.wireframe),this.style===y?(a.lineWidth(1),a.uniform1f(b.depthOffset,-0.01),this.setColor(b.color,COLORS.black,0.75),a.drawElements(a.LINES,e.wireframe.count,a.UNSIGNED_SHORT,0)):this.style===z?(a.lineWidth(1),a.uniform1f(b.depthOffset,-0.01),this.setColor(b.color,COLORS.black,0.75),a.drawElements(a.LINES,e.wireframe.count/2,a.UNSIGNED_SHORT,e.wireframe.count)):(a.lineWidth(2),a.uniform1f(b.depthOffset,
0.01),this.setColor(b.color,COLORS.black,1),a.drawElements(a.LINES,e.wireframe.count,a.UNSIGNED_SHORT,0),this.sketchy&&(a.lineWidth(1),this.setColor(b.color,COLORS.darkgray,1),a.uniform1f(b.depthOffset,-0.01),a.drawElements(a.LINES,e.wireframe.count/2,a.UNSIGNED_SHORT,e.wireframe.count))),a.disableVertexAttribArray(semantics.POSITION)};f.prototype.compileShaders=function(){var a,b,c,d,e,f;e=i.shaders;f=[];for(c in e)b=e[c],"source"!==c&&(a=b.keys,d=a[0],a=a[1],f.push(this.programs[c]=this.compileProgram(d,
a,b.attribs,b.uniforms)));return f};f.prototype.compileShader=function(g,b){var c,d;d=i.shaders.source[g];c=a.createShader(b);a.shaderSource(c,d);a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||$.gritter.add({title:"GLSL Error: "+g,text:a.getShaderInfoLog(c)});return c};f.prototype.compileProgram=function(g,b,c,d){var e,f,i;i=this.compileShader(g,a.VERTEX_SHADER);d=this.compileShader(b,a.FRAGMENT_SHADER);f=a.createProgram();a.attachShader(f,i);a.attachShader(f,d);for(e in c)d=c[e],a.bindAttribLocation(f,
d,e);a.linkProgram(f);a.getProgramParameter(f,a.LINK_STATUS)||glerr("Could not link "+g+" with "+b);b=a.getProgramParameter(f,a.ACTIVE_UNIFORMS);d=[];for(g=c=0;0<=b?c<b:c>b;g=0<=b?++c:--c)d.push(a.getActiveUniform(f,g).name);b=0;for(c=d.length;b<c;b++)g=d[b],f[g]=a.getUniformLocation(f,g);return f};return f}();i.Display=A;(function(){var a,g,b,c;b=["sin","cos","pow","abs"];c=[];a=0;for(g=b.length;a<g;a++)C=b[a],c.push(Math[C]);return c})();B=2*Math.PI;p=utility.aabb;y=0;n=1;z=2}).call(this);
