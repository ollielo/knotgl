(function(){var m,z,q,g,a,i;i="undefined"!==typeof exports&&null!==exports?exports:this;a=null;g=function(f,b,c){var d=this;this.width=b;this.height=c;a=f;this.ready=!1;this.radiansPerSecond=3E-4;this.transitionMilliseconds=750;this.style=m.SILHOUETTE;this.sketchy=!0;this.programs={};this.hotMouse=!1;this.initializeGL();this.gallery=new i.Gallery;this.highlightRow=this.gallery.j;this.worker=new Worker("js/worker.min.js");this.worker.onmessage=function(a){return d.onWorkerMessage(a.data)};this.worker.postMessage({command:"download-spines",
url:document.URL+"data/centerlines.bin"})};g.prototype.render=function(){var f,b,c,d,e,h,k,j,g,l;this.gallery.row().loaded||this.tessRow();f=(new Date).getTime();if(null!=this.previousTime){c=f-this.previousTime;b=this.radiansPerSecond*c;0===i.pageIndex&&(b*=32);h=null!=(e=this.highlightRow)?e:null;1===i.pageIndex&&(h=this.gallery.j);j=this.gallery.links;c=k=0;for(d=j.length;k<d;c=++k)e=j[c],e.theta=c===h||Math.abs(e.theta%z)>b?e.theta+b:0}this.previousTime=f;this.projection=mat4.perspective(45,this.width/
this.height,5,90);f=mat4.lookAt([0,-5,5],[0,0,0],[0,1,0]);this.updateViewports();k=this.gallery.links;c=b=0;for(h=k.length;b<h;c=++b){e=k[c];d=mat4.create();this.modelview=mat4.create();mat4.identity(d);mat4.rotateX(d,0.785);mat4.rotateY(d,e.theta);mat4.multiply(f,d,this.modelview);this.normalMatrix=mat4.toMat3(this.modelview);j=0;for(g=e.length;j<g;j++)d=e[j],0===d.iconified&&(d.alpha=0.3),1===d.iconified&&(d.alpha=1);j=0;for(g=e.length;j<g;j++)d=e[j],null==d.hidden&&this.renderIconLink(d,d.tableBox,
1);if(c===this.gallery.j){j=0;for(c=e.length;j<c;j++)d=e[j],d.ready&&this.renderIconLink(d,d.iconBox,d.alpha);for(c=g=0;1>=g;c=++g){l=0;for(j=e.length;l<j;l++)d=e[l],this.renderBigLink(d,c)}}}if(a.getError()!==a.NO_ERROR)return glerr("Render")};g.prototype.renderIconLink=function(a,b,c){var d,e,h,k;k=[];e=0;for(h=a.length;e<h;e++)d=a[e],k.push(this.renderIconKnot(d,a,b,c));return k};g.prototype.renderBigLink=function(a,b){var c,d,e,h;h=[];d=0;for(e=a.length;d<e;d++)c=a[d],h.push(this.renderBigKnot(c,
a,b));return h};g.prototype.initializeGL=function(){this.compileShaders();a.enable(a.CULL_FACE);if(a.getError()!==a.NO_ERROR)return glerr("OpenGL error during init")};g.prototype.onWorkerMessage=function(f){var b,c,d,e,h,k;switch(f.command){case "debug-message":return toast(f.text);case "spine-data":return this.spines=this.createVbo(a.ARRAY_BUFFER,f.data),this.spines.scale=f.scale,this.ready=!0;case "mesh-link":b=f.id;d=b[1];b=b[2];b=this.gallery.link(d,b);k=f.meshes;c=e=0;for(h=k.length;e<h;c=++e)f=
k[c],c=b[c].vbos={},c.tube=this.createVbo(a.ARRAY_BUFFER,f.tube),c.wireframe=this.createVbo(a.ELEMENT_ARRAY_BUFFER,f.wireframe),c.triangles=this.createVbo(a.ELEMENT_ARRAY_BUFFER,f.triangles);d=this.gallery.links[d];++d.loadCount===d.length&&(d.loaded=!0,d.loading=!1);return b.ready=!0}};g.prototype.createVbo=function(f,b){var c;c=a.createBuffer();a.bindBuffer(f,c);a.bufferData(f,b,a.STATIC_DRAW);c.count=b.length;return c};g.prototype.tessRow=function(){var a,b,c,d,e,h;c=this.gallery.row();if(!c.loaded&&
!c.loading&&this.ready&&0!==i.pageIndex){c.loading=!0;c.loadCount=0;h=[];d=0;for(e=c.length;d<e;d++){b=c[d];for(var k=b.id,g=void 0,r=void 0,l=void 0,l=[],g=0,r=b.length;g<r;g++)a=b[g],l.push(a.range);a={command:"tessellate-link",id:k,link:l};h.push(this.worker.postMessage(a))}return h}};g.prototype.getCurrentLinkInfo=function(){var a;a=this.gallery.link().id[0].split(".");return 2===a.length?{crossings:a[0],numComponents:"",index:a[1]}:{crossings:a[0],numComponents:a[1],index:a[2]}};g.prototype.moveSelection=
function(a,b){var c,d;c=this.gallery.i+a;d=this.gallery.j+b;if(!(d>=this.gallery.links.length||0>d))if(!(c>=this.gallery.links[d].length||0>c))return this.changeSelection(c,d)};g.prototype.changeSelection=function(a,b){var c,d,e,h,g;e=this.gallery.i;d=!1;if(b!==this.gallery.j){g=this.gallery.links[b];c=0;for(h=g.length;c<h;c++)d=g[c],d.iconified=1;this.gallery.links[b][a].ready||(a=0);this.gallery.links[b][a].iconified=0;this.highlightRow=b;d=!0}this.gallery.i=a;this.gallery.j=b;i.StartNumeralAnimation();
c=this.gallery.row();if(!d)if(d=c[this.gallery.i],e=c[e],0===e.iconified)c=this.transitionMilliseconds,this.incoming1=(new TWEEN.Tween(d)).to({alpha:0.3},c).start(),this.incoming2=(new TWEEN.Tween(d)).to({iconified:0},c).easing(TWEEN.Easing.Bounce.Out).start(),c=0.5*this.transitionMilliseconds,(new TWEEN.Tween(e)).to({alpha:1},c).start(),(new TWEEN.Tween(e)).to({iconified:1},c).easing(TWEEN.Easing.Quartic.Out).start();else if(c=e.iconified,e.iconified=1,d.iconified=c,c=e.alpha,e.alpha=1,d.alpha=c,
null!=this.incoming1&&this.incoming1.replace(d),null!=this.incoming2)return this.incoming2.replace(d)};g.prototype.updateViewports=function(){var a,b,c,d,e,h,g,j,r,l,m,n,u,v,p,w,x,s,y,t;a=new q(0,0,this.width,this.height);j=vec2.create([i.mouse.position.x,this.height-i.mouse.position.y]);this.hotMouse=!1;t=[];m=x=0;for(y=this.gallery.links.length;0<=y?x<y:x>y;m=0<=y?++x:--x){l=this.gallery.links[m];d=n=this.height/this.gallery.links.length;v=n*this.width/this.height;u=this.width/(l.length+0.5);p=
-this.width+u/2;w=this.height-n/2-n*m;n=0;for(s=l.length;n<s;n++)h=l[n],h.tableBox=q.createFromCenter([p,w],[v,d]),h.tableBox.inflate(v/5,d/5),p+=u;m===this.gallery.j&&(v=u=this.width/l.length,d=n=u*this.height/this.width,p=u/2,w=this.height-n/2,t.push(function(){var i,m,n;n=[];i=0;for(m=l.length;i<m;i++)h=l[i],e=q.createFromCenter([p,w],[v,d]),c=vec2.dist([p,w],j),r=d/2,c<r&&1===h.iconified&&(b=1-c/r,g=r/3,e.inflate(b*b*g),this.hotMouse=!0),h.iconBox=e,h.centralBox=q.lerp(a,e,h.iconified),n.push(p+=
v);return n}.call(this)))}return t};g.prototype.click=function(){var a,b,c,d,e,h,g;if(null!=this.gallery.links){d=this.gallery.row();c=vec2.create([i.mouse.position.x,this.height-i.mouse.position.y]);g=[];b=e=0;for(h=d.length;e<h;b=++e)(a=d[b])&&a.iconBox&&(a.iconBox.contains(c[0],c[1])&&1===a.iconified?g.push(this.changeSelection(b,this.gallery.j)):g.push(void 0));return g}};g.prototype.setColor=function(f,b,c){return a.uniform4f(f,b[0],b[1],b[2],c)};g.prototype.setViewport=function(f){var b,c,f=
f.translated(i.pan.x*i.pixelRatio,0);b=new q(0,0,this.width,this.height);b=q.intersect(f,b);if(b.degenerate())return null;f=q.cropMatrix(b,f);c=mat4.create(this.projection);mat4.multiply(c,f);b.viewport(a);return c};g.prototype.renderIconKnot=function(f,b,c,d){var e,h,g,j,i;if(c=this.setViewport(c)){b=this.programs.wireframe;a.useProgram(b);a.uniform3f(b.worldOffset,f.offset[0],f.offset[1],f.offset[2]);a.enable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);a.bindBuffer(a.ARRAY_BUFFER,this.spines);
a.enableVertexAttribArray(semantics.POSITION);a.vertexAttribPointer(semantics.POSITION,3,a.FLOAT,!1,12,0);a.uniformMatrix4fv(b.modelview,!1,this.modelview);a.uniformMatrix4fv(b.projection,!1,c);a.uniform1f(b.scale,this.spines.scale);this.setColor(b.color,COLORS.black,d);e=f.range;c=e[0];e=e[1];a.enable(a.DEPTH_TEST);a.lineWidth(2);for(h=j=-1;1>=j;h=j+=2)for(g=i=-1;1>=i;g=i+=2)a.uniform2f(b.screenOffset,h,g),a.uniform1f(b.depthOffset,0),a.drawArrays(a.LINE_LOOP,c,e);this.setColor(b.color,f.color,d);
a.uniform2f(b.screenOffset,0,0);a.uniform1f(b.depthOffset,-0.5);a.drawArrays(a.LINE_LOOP,c,e);return a.disableVertexAttribArray(semantics.POSITION)}};g.prototype.renderBigKnot=function(f,b,c){var d,e;if(1!==b.iconified&&null!=f.vbos&&(d=this.setViewport(b.centralBox)))if(e=f.vbos,0===c&&(b=this.programs.solidmesh,a.enable(a.DEPTH_TEST),a.useProgram(b),this.setColor(b.color,f.color,1),a.uniform3f(b.worldOffset,f.offset[0],f.offset[1],f.offset[2]),a.uniformMatrix4fv(b.modelview,!1,this.modelview),a.uniformMatrix3fv(b.normalmatrix,
!1,this.normalMatrix),a.uniformMatrix4fv(b.projection,!1,d),a.bindBuffer(a.ARRAY_BUFFER,e.tube),a.enableVertexAttribArray(semantics.POSITION),a.enableVertexAttribArray(semantics.NORMAL),a.vertexAttribPointer(semantics.POSITION,3,a.FLOAT,!1,24,0),a.vertexAttribPointer(semantics.NORMAL,3,a.FLOAT,!1,24,12),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.triangles),this.style===m.SILHOUETTE&&(a.enable(a.POLYGON_OFFSET_FILL),a.polygonOffset(-1,12)),a.drawElements(a.TRIANGLES,e.triangles.count,a.UNSIGNED_SHORT,0),
a.disableVertexAttribArray(semantics.POSITION),a.disableVertexAttribArray(semantics.NORMAL),a.disable(a.POLYGON_OFFSET_FILL)),1===c)return a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),b=this.programs.wireframe,a.useProgram(b),a.uniform3f(b.worldOffset,f.offset[0],f.offset[1],f.offset[2]),a.uniformMatrix4fv(b.modelview,!1,this.modelview),a.uniformMatrix4fv(b.projection,!1,d),a.uniform1f(b.scale,1),a.bindBuffer(a.ARRAY_BUFFER,e.tube),a.enableVertexAttribArray(semantics.POSITION),
a.vertexAttribPointer(semantics.POSITION,3,a.FLOAT,!1,24,0),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,e.wireframe),this.style===m.WIREFRAME?(a.lineWidth(1),a.uniform1f(b.depthOffset,-0.01),this.setColor(b.color,COLORS.black,0.75),a.drawElements(a.LINES,e.wireframe.count,a.UNSIGNED_SHORT,0)):this.style===m.RINGS?(a.lineWidth(1),a.uniform1f(b.depthOffset,-0.01),this.setColor(b.color,COLORS.black,0.75),a.drawElements(a.LINES,e.wireframe.count/2,a.UNSIGNED_SHORT,e.wireframe.count)):(a.lineWidth(2),a.uniform1f(b.depthOffset,
0.01),this.setColor(b.color,COLORS.black,1),a.drawElements(a.LINES,e.wireframe.count,a.UNSIGNED_SHORT,0),this.sketchy&&(a.lineWidth(1),this.setColor(b.color,COLORS.darkgray,1),a.uniform1f(b.depthOffset,-0.01),a.drawElements(a.LINES,e.wireframe.count/2,a.UNSIGNED_SHORT,e.wireframe.count))),a.disableVertexAttribArray(semantics.POSITION)};g.prototype.compileShaders=function(){var a,b,c,d,e,h;e=i.shaders;h=[];for(c in e)b=e[c],"source"!==c&&(a=b.keys,d=a[0],a=a[1],h.push(this.programs[c]=this.compileProgram(d,
a,b.attribs,b.uniforms)));return h};g.prototype.compileShader=function(f,b){var c,d;d=i.shaders.source[f];c=a.createShader(b);a.shaderSource(c,d);a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||$.gritter.add({title:"GLSL Error: "+f,text:a.getShaderInfoLog(c)});return c};g.prototype.compileProgram=function(f,b,c,d){var e,h,g;g=this.compileShader(f,a.VERTEX_SHADER);d=this.compileShader(b,a.FRAGMENT_SHADER);h=a.createProgram();a.attachShader(h,g);a.attachShader(h,d);for(e in c)d=c[e],a.bindAttribLocation(h,
d,e);a.linkProgram(h);a.getProgramParameter(h,a.LINK_STATUS)||glerr("Could not link "+f+" with "+b);b=a.getProgramParameter(h,a.ACTIVE_UNIFORMS);d=[];for(f=c=0;0<=b?c<b:c>b;f=0<=b?++c:--c)d.push(a.getActiveUniform(h,f).name);b=0;for(c=d.length;b<c;b++)f=d[b],h[f]=a.getUniformLocation(h,f);return h};i.Display=g;var s,A,t,B;t=["sin","cos","pow","abs"];B=[];s=0;for(A=t.length;s<A;s++)g=t[s],B.push(Math[g]);z=2*Math.PI;q=utility.aabb;m={WIREFRAME:0,SILHOUETTE:1,RINGS:2}}).call(this);
